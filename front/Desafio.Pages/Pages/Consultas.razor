@page "/consultas"
@inject ApiService ApiService
@inject MessageService MessageService

<!-- Tela de consultas gerais: contas, transações e pessoas -->

<PageTitle>Consultas</PageTitle>

<link href="Consultas.css" rel="stylesheet" />

<div class="consultas-container">
    <div class="header">
        <h1>Consultas do Sistema</h1>
        <p>Selecione o tipo de dados que deseja consultar</p>
    </div>

    <div class="controls">
        <div class="form-group">
            <label for="opcao">Tipo de Consulta:</label>
            <select id="opcao" class="form-control" @bind="opcaoSelecionada" @bind:after="OnOpcaoChanged">
                <option value="contas">Contas</option>
                <option value="transacoes">Transações</option>
                <option value="pessoas">Pessoas</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="pesquisa">Pesquisa:</label>
            <input id="pesquisa" class="form-control" placeholder="@PlaceholderPesquisa" @bind="termoPesquisa" @bind:event="oninput" @bind:after="OnPesquisaChanged" />
        </div>
    </div>

    @if (dadosFiltrados != null && dadosFiltrados.Count > 0)
    {
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        @foreach (var col in colunas)
                        {
                            <th @onclick="(() => OrdenarPor(col))" style="cursor: pointer; white-space: nowrap;">
                                @col
                                @if (ordenacaoColuna == col)
                                {
                                    <span>@(ordenacaoAsc ? "▲" : "▼")</span>
                                }
                            </th>
                        }
                        @if (opcaoSelecionada == "contas" || opcaoSelecionada == "pessoas")
                        {
                            <th>Ações</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in dadosFiltrados)
                    {
                        <tr>
                            @foreach (var col in colunas)
                            {
                                                                 <td>
                                    @{
                                        var valor = item.ContainsKey(col) ? item[col] : "";
                                        if (col == "ativo")
                                        {
                                            <span class="@(valor.ToString() == "True" ? "status-active" : "status-inactive")">
                                                @(valor.ToString() == "True" ? "Ativo" : "Inativo")
                                            </span>
                                        }
                                        else
                                        {
                                            @valor
                                        }
                                    }
                                </td>
                            }
                            @if (opcaoSelecionada == "contas" || opcaoSelecionada == "pessoas")
                            {
                                <td>
                                    <button class="btn btn-sm btn-secondary" @onclick="(() => Editar(item))">Editar</button>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else if (dados != null)
    {
        <div class="alert alert-info">
            <p>Nenhum dado encontrado.</p>
        </div>
    }

    <MessageAlert Message="@MessageService.Message" MessageClass="@MessageService.MessageClass" />
</div>

@code {
    // Navegação e estado base
    [Inject] private NavigationManager Nav { get; set; } = default!;
    private string opcaoSelecionada = "contas";
    private List<Dictionary<string, object>>? dados = null;
    private List<Dictionary<string, object>>? dadosFiltrados = null;
    private List<string> colunas = new();
    private string termoPesquisa = string.Empty;
    private string? ordenacaoColuna = null;
    private bool ordenacaoAsc = true;


    // Busca os dados conforme a opção selecionada
    private async Task BuscarDados()
    {
        try
        {
            string endpoint = opcaoSelecionada switch
            {
                "contas" => "/api/Conta/ObterTodasContas",
                "transacoes" => "/api/Transacao/ObterTodasTransacoes",
                "pessoas" => "/api/Pessoa/ObterTodasPessoas",
                _ => "/api/Conta/ObterTodasContas"
            };

            var resultado = await ApiService.GetAsync<List<Dictionary<string, object>>>(endpoint);
            dados = resultado ?? new List<Dictionary<string, object>>();

            colunas = (dados.Count > 0) ? dados[0].Keys.ToList() : new List<string>();

            // Formatar dados conforme o tipo
            if (dados.Count > 0)
            {
                foreach (var item in dados)
                {
                    switch (opcaoSelecionada)
                    {
                        case "contas":
                            DataFormattingService.FormatContaData(item);
                            break;
                        case "transacoes":
                            DataFormattingService.FormatTransacaoData(item);
                            break;
                        case "pessoas":
                            DataFormattingService.FormatPessoaData(item);
                            break;
                    }
                }
            }

            AplicarFiltro();
        }
        catch (Exception ex)
        {
            MessageService.ShowError($"Erro ao carregar dados: {ex.Message}");
            dados = new List<Dictionary<string, object>>();
            colunas = new List<string>();
            dadosFiltrados = new List<Dictionary<string, object>>();
        }
    }

    // Aplica pesquisa textual básica
    private void AplicarFiltro()
    {
        if (dados == null)
        {
            dadosFiltrados = new List<Dictionary<string, object>>();
            return;
        }

        var termo = (termoPesquisa ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(termo))
        {
            dadosFiltrados = dados.ToList();
            AplicarOrdenacao();
            return;
        }

        if (opcaoSelecionada == "contas")
        {
            dadosFiltrados = dados.Where(d =>
                (d.ContainsKey("pessoa") && d["pessoa"]?.ToString()?.Contains(termo, StringComparison.OrdinalIgnoreCase) == true)
            ).ToList();
        }
        else if (opcaoSelecionada == "pessoas")
        {
            dadosFiltrados = dados.Where(d =>
                (d.ContainsKey("nome") && d["nome"]?.ToString()?.Contains(termo, StringComparison.OrdinalIgnoreCase) == true)
            ).ToList();
        }
        else if (opcaoSelecionada == "transacoes")
        {
            dadosFiltrados = dados.Where(d =>
                (d.ContainsKey("conta") && d["conta"]?.ToString()?.Contains(termo, StringComparison.OrdinalIgnoreCase) == true)
            ).ToList();
        }
        else
        {
            dadosFiltrados = dados.ToList();
        }

        AplicarOrdenacao();
    }

    // Ordena por coluna clicada (toggle asc/desc)
    private void OrdenarPor(string coluna)
    {
        if (ordenacaoColuna == coluna)
        {
            ordenacaoAsc = !ordenacaoAsc;
        }
        else
        {
            ordenacaoColuna = coluna;
            ordenacaoAsc = true;
        }
        AplicarOrdenacao();
    }

    // Ordenação genérica por valor (número, data, string)
    private void AplicarOrdenacao()
    {
        if (dadosFiltrados == null || string.IsNullOrEmpty(ordenacaoColuna)) return;

        Func<Dictionary<string, object>, object?> keySelector = d => d.ContainsKey(ordenacaoColuna) ? d[ordenacaoColuna] : null;

        int CompareValues(object? a, object? b)
        {
            if (a == null && b == null) return 0;
            if (a == null) return -1;
            if (b == null) return 1;

            // Tentar comparar como número
            if (decimal.TryParse(a.ToString(), System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var da) &&
                decimal.TryParse(b.ToString(), System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var db))
            {
                return da.CompareTo(db);
            }

            // Tentar comparar como data
            if (DateTime.TryParse(a.ToString(), out var ta) && DateTime.TryParse(b.ToString(), out var tb))
            {
                return ta.CompareTo(tb);
            }

            // Comparar como string
            return string.Compare(a.ToString(), b.ToString(), StringComparison.OrdinalIgnoreCase);
        }

        dadosFiltrados = (ordenacaoAsc
            ? dadosFiltrados.OrderBy(keySelector, Comparer<object?>.Create(CompareValues))
            : dadosFiltrados.OrderByDescending(keySelector, Comparer<object?>.Create(CompareValues)))
            .ToList();
    }

    private string PlaceholderPesquisa => opcaoSelecionada switch
    {
        "contas" => "Pesquisar por nome da pessoa",
        "pessoas" => "Pesquisar por nome",
        "transacoes" => "Pesquisar por número da conta",
        _ => "Pesquisar"
    };

    // Reaplica filtro quando parâmetros mudam
    protected override void OnParametersSet()
    {
        AplicarFiltro();
    }

    // Botão de editar por linha, navega para tela de edição
    private void Editar(Dictionary<string, object> item)
    {
        if (opcaoSelecionada == "contas")
        {
            // Id pode vir como "IdConta" dependendo da serialização
            var chaveId = item.Keys.FirstOrDefault(k => string.Equals(k, "idConta", StringComparison.OrdinalIgnoreCase));
            if (chaveId != null)
            {
                var idStr = item[chaveId]?.ToString();
                if (int.TryParse(idStr, out var id))
                {
                    Nav.NavigateTo($"/editar-conta/{id}");
                    return;
                }
            }
        }
        else if (opcaoSelecionada == "pessoas")
        {
            var chaveId = item.Keys.FirstOrDefault(k => string.Equals(k, "idPessoa", StringComparison.OrdinalIgnoreCase));
            if (chaveId != null)
            {
                var idStr = item[chaveId]?.ToString();
                if (int.TryParse(idStr, out var id))
                {
                    Nav.NavigateTo($"/editar-pessoa/{id}");
                    return;
                }
            }
        }
        Console.WriteLine($"Editar: {System.Text.Json.JsonSerializer.Serialize(item)}");
    }

    // Quando muda o select, recarrega os dados
    protected override async Task OnInitializedAsync()
    {
        await BuscarDados();
        MessageService.OnMessageChanged += StateHasChanged;
    }

    private async Task OnOpcaoChanged()
    {
        await BuscarDados();
    }

    private Task OnPesquisaChanged()
    {
        AplicarFiltro();
        return Task.CompletedTask;
    }

}